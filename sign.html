<script type="module">
  import { TonConnect } from "https://unpkg.com/@tonconnect/sdk@latest";

  const urlParams = new URLSearchParams(window.location.search);
  const to = urlParams.get("to");
  const amount = urlParams.get("amount");

  const statusEl = document.createElement("div");
  statusEl.style = "padding: 1rem; font-family: sans-serif; font-size: 1.2rem;";
  document.body.appendChild(statusEl);

  async function run() {
    try {
      const connector = new TonConnect({
        manifestUrl: "https://gigi-ton-connect-v2-deploy.onrender.com/tonconnect-manifest.json"
      });

      await connector.restoreConnection();

      // ❗ Wait for wallet connect if not already connected
      if (!connector.connected) {
        await connector.connect(); // Prompts Telegram Wallet to connect
      }

      if (!connector.connected) {
        statusEl.textContent = "❌ Wallet not connected.";
        return;
      }

      // ✅ If connected, proceed to send the transaction
      await connector.sendTransaction({
        validUntil: Math.floor(Date.now() / 1000) + 600,
        messages: [
          {
            address: to,
            amount: amount
          }
        ]
      });

      statusEl.textContent = "✅ Transaction sent to TON Wallet!";
    } catch (err) {
      console.error(err);
      statusEl.textContent = "❌ Signing cancelled or failed.";
    }
  }

  run();
</script>
