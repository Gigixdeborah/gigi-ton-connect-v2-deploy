<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gigi Wallet Sign</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 40px; }
    button { padding: 12px 24px; margin: 10px; font-size: 16px; }
  </style>
</head>
<body>
  <h2>üîê Connect and Sign with Your Wallet</h2>
  <p id="status">Select your wallet below üëá</p>

  <button onclick="signWithTon()">üî∑ Sign with TON</button>
  <button onclick="signWithMetaMask()">ü¶ä Sign with MetaMask</button>
  <button onclick="signWithPhantom()">üëª Sign with Phantom</button>

  <script type="module">
    const url = new URL(window.location.href);
    const amount = url.searchParams.get("amount");
    const to = url.searchParams.get("to");
    const token = url.searchParams.get("token") || "ton"; // token used to detect network

    // TON
    async function signWithTon() {
      try {
        document.getElementById("status").innerText = "‚è≥ Connecting to TON Wallet...";
        const { TonConnect } = await import("https://unpkg.com/@tonconnect/sdk@latest");
        const tonConnect = new TonConnect({
          manifestUrl: "https://gigi-ton-connect-v2.onrender.com/tonconnect-manifest.json"
        });

        const connected = await tonConnect.restoreConnection();
        if (!connected) await tonConnect.connectWallet();

        await tonConnect.sendTransaction({
          validUntil: Math.floor(Date.now() / 1000) + 600,
          messages: [{ address: to, amount }]
        });

        document.getElementById("status").innerText = "‚úÖ TON transaction sent!";
      } catch (err) {
        document.getElementById("status").innerText = "‚ùå TON sign failed.";
        console.error(err);
      }
    }

    // MetaMask
    async function signWithMetaMask() {
      try {
        document.getElementById("status").innerText = "ü¶ä Connecting to MetaMask...";
        if (!window.ethereum) return alert("MetaMask not found!");

        const [account] = await window.ethereum.request({ method: "eth_requestAccounts" });
        const tx = {
          from: account,
          to: to,
          value: `0x${parseInt(amount).toString(16)}`,
          gas: "0x5208"
        };

        const txHash = await window.ethereum.request({
          method: "eth_sendTransaction",
          params: [tx]
        });

        document.getElementById("status").innerText = `‚úÖ TX Hash: ${txHash}`;
      } catch (err) {
        document.getElementById("status").innerText = "‚ùå MetaMask sign failed.";
        console.error(err);
      }
    }

    // Phantom (Solana)
    async function signWithPhantom() {
      try {
        document.getElementById("status").innerText = "üëª Connecting to Phantom...";
        const provider = window.phantom?.solana;
        if (!provider) return alert("Phantom Wallet not found!");

        await provider.connect();
        const from = provider.publicKey;
        const connection = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com");

        const transaction = new solanaWeb3.Transaction().add(
          solanaWeb3.SystemProgram.transfer({
            fromPubkey: from,
            toPubkey: new solanaWeb3.PublicKey(to),
            lamports: parseInt(amount) // in lamports (1 SOL = 1e9 lamports)
          })
        );

        transaction.feePayer = from;
        transaction.recentBlockhash = (await connection.getRecentBlockhash()).blockhash;

        const signed = await provider.signTransaction(transaction);
        const signature = await connection.sendRawTransaction(signed.serialize());

        document.getElementById("status").innerText = `‚úÖ TX Signature: ${signature}`;
      } catch (err) {
        document.getElementById("status").innerText = "‚ùå Phantom sign failed.";
        console.error(err);
      }
    }
  </script>

  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
</body>
</html>
