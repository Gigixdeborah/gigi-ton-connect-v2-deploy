<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TON Connect Sign Request</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      padding: 2rem;
    }

    .status {
      font-size: 1.2rem;
      margin-top: 1rem;
    }

    .error { color: #ff4b4b; }
    .success { color: #00ffcc; }
    .loading { color: #00bfff; }

    .qr-box {
      margin-top: 2rem;
      border: 1px solid #444;
      padding: 1rem;
      display: inline-block;
      background: #111;
    }

    canvas {
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <h2>TON Connect Sign Request</h2>
  <div id="status" class="status loading">üîÑ Connecting to wallet...</div>
  <div id="qr-container" class="qr-box" style="display:none;"></div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script>
    (async () => {
      const status = document.getElementById("status");
      const qrContainer = document.getElementById("qr-container");

      const urlParams = new URLSearchParams(window.location.search);
      const to = urlParams.get("to");
      const amount = urlParams.get("amount");

      if (!to || !amount) {
        status.textContent = "‚ùå Missing amount or address";
        status.className = "status error";
        return;
      }

      const connector = new window.TonConnectSDK.TonConnect({
        manifestUrl: "https://gigi-ton-connect-v2.onrender.com/tonconnect-manifest.json"
      });

      try {
        const wallets = await connector.getWallets();
        const injected = wallets.find(w => w.embedded);

        if (!connector.connected) {
          if (injected) {
            await connector.connect({ jsBridgeKey: injected.jsBridgeKey });
          } else {
            // Show QR code fallback
            const universalLink = connector.connect({
              universalLink: "https://app.tonkeeper.com/ton-connect",
              bridgeUrl: "https://bridge.tonapi.io/bridge"
            });
            qrContainer.style.display = "block";
            status.textContent = "üì± Scan this QR code with TON Wallet";
            status.className = "status loading";
            QRCode.toCanvas(document.createElement("canvas"), await universalLink, function (err, canvas) {
              if (!err) qrContainer.appendChild(canvas);
            });
            return;
          }
        }

        if (!connector.connected) {
          status.textContent = "‚ùå Wallet not connected.";
          status.className = "status error";
          return;
        }

        const nano = parseFloat(amount) * 1e9;
        const tx = {
          validUntil: Math.floor(Date.now() / 1000) + 600,
          messages: [
            {
              address: to,
              amount: nano.toString(),
            },
          ],
        };

        status.textContent = "üöÄ Sending transaction to wallet...";
        status.className = "status loading";

        const result = await connector.sendTransaction(tx);

        status.textContent = `‚úÖ Transaction sent! BOC: ${result.boc}`;
        status.className = "status success";
      } catch (err) {
        console.error("Signing error:", err);
        status.textContent = "‚ùå Signing cancelled or failed.";
        status.className = "status error";
      }
    })();
  </script>
</body>
</html>
